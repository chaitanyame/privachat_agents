openapi: 3.0.0
info:
  title: Research Service API
  version: 0.1.0
  description: Advanced search and research service with multi-agent architecture
  contact:
    name: Support
    url: http://localhost:8001/api/docs
  license:
    name: Apache 2.0

servers:
  - url: http://localhost:8001/api
    description: Development server
  - url: http://api.example.com/api
    description: Production server

paths:
  /v1/health:
    get:
      summary: Health check endpoint
      tags:
        - Health
      operationId: health_check
      responses:
        '200':
          description: Service health status
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy, degraded, unhealthy]
                    example: healthy
                  service:
                    type: string
                    example: research-service
                  version:
                    type: string
                    example: 0.1.0
                  environment:
                    type: string
                    enum: [development, production]
                    example: development

  /v1/search:
    post:
      summary: Perform fast web search with answer synthesis
      tags:
        - Search
      operationId: search
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SearchRequest'
      responses:
        '200':
          description: Search completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '408':
          description: Search timeout
        '503':
          description: Search engines unavailable

  /v1/research:
    post:
      summary: Perform deep iterative research
      tags:
        - Research
      operationId: research
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResearchRequest'
      responses:
        '200':
          description: Research completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResearchResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '408':
          description: Research timeout
        '503':
          description: Search engines unavailable

  /v1/documents/upload:
    post:
      summary: Upload and process a document
      tags:
        - Documents
      operationId: upload_document
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: Document file (PDF, Word, Excel, or text)
                collection:
                  type: string
                  description: Collection name for organization
                  default: default
              required:
                - file
      responses:
        '201':
          description: Document uploaded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DocumentUploadResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/documents/query:
    post:
      summary: Query uploaded documents using RAG
      tags:
        - Documents
      operationId: query_documents
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DocumentQueryRequest'
      responses:
        '200':
          description: Query processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DocumentQueryResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          description: Collection not found
        '500':
          $ref: '#/components/responses/InternalError'

  /v1/documents:
    get:
      summary: List uploaded documents
      tags:
        - Documents
      operationId: list_documents
      parameters:
        - name: collection
          in: query
          schema:
            type: string
          description: Filter by collection name
        - name: skip
          in: query
          schema:
            type: integer
            default: 0
          description: Pagination offset
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
          description: Pagination limit
      responses:
        '200':
          description: Documents retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  documents:
                    type: array
                    items:
                      $ref: '#/components/schemas/DocumentListItem'
                  total:
                    type: integer
                  skip:
                    type: integer
                  limit:
                    type: integer

  /v1/documents/{document_id}:
    delete:
      summary: Delete an uploaded document
      tags:
        - Documents
      operationId: delete_document
      parameters:
        - name: document_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Document UUID
      responses:
        '200':
          description: Document deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  document_id:
                    type: string
                    format: uuid
                  status:
                    type: string
                    enum: [deleted]
                  message:
                    type: string
        '404':
          description: Document not found

  /v1/sessions/{session_id}:
    get:
      summary: Get session details
      tags:
        - Sessions
      operationId: get_session
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Session UUID
      responses:
        '200':
          description: Session retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
        '404':
          description: Session not found

components:
  schemas:
    SearchRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          minLength: 1
          maxLength: 1000
          description: Search query
          example: What is Pydantic AI?
        mode:
          type: string
          enum: [speed, balanced, deep]
          default: balanced
          description: Search mode (affects sources and timeout)
        max_sources:
          type: integer
          minimum: 5
          maximum: 50
          description: Maximum number of sources to retrieve
        timeout:
          type: integer
          minimum: 10
          maximum: 300
          description: Timeout in seconds
        model:
          type: string
          nullable: true
          description: LLM model to use
          example: anthropic/claude-3.5-sonnet
        search_engine:
          type: string
          enum: [searxng, serperdev, perplexity, auto]
          default: auto
          description: Search engine backend
        prompt_strategy:
          type: string
          enum: [static, dynamic, auto]
          default: auto
          description: System prompt strategy
        enable_diversity:
          type: boolean
          default: false
          description: Enable diversity penalty for deduplication
        enable_recency:
          type: boolean
          default: false
          description: Enable recency boost for temporal queries
        enable_query_aware:
          type: boolean
          default: false
          description: Enable query-aware score adaptations

    SearchResponse:
      type: object
      properties:
        session_id:
          type: string
          format: uuid
          description: Unique session identifier
        query:
          type: string
          description: Original search query
        answer:
          type: string
          description: AI-generated answer
        sub_queries:
          type: array
          items:
            $ref: '#/components/schemas/SubQueryResponse'
        sources:
          type: array
          items:
            $ref: '#/components/schemas/SearchSourceResponse'
        mode:
          type: string
          description: Search mode used
        execution_time:
          type: number
          description: Execution time in seconds
        confidence:
          type: number
          minimum: 0.0
          maximum: 1.0
          description: Result confidence score
        model_used:
          type: string
          description: LLM model used
        trace_url:
          type: string
          nullable: true
          description: Langfuse trace URL
        grounding_score:
          type: number
          minimum: 0.0
          maximum: 1.0
          nullable: true
          description: Hallucination detection score
        hallucination_count:
          type: integer
          minimum: 0
          nullable: true
          description: Number of unsupported claims
        created_at:
          type: string
          format: date-time
          description: Response timestamp

    SearchSourceResponse:
      type: object
      properties:
        title:
          type: string
          description: Source title
        url:
          type: string
          format: uri
          description: Source URL
        snippet:
          type: string
          description: Content excerpt
        relevance:
          type: number
          minimum: 0.0
          maximum: 1.0
          description: Search API relevance score
        semantic_score:
          type: number
          minimum: 0.0
          maximum: 1.0
          nullable: true
          description: Semantic reranking score
        final_score:
          type: number
          minimum: 0.0
          maximum: 1.0
          description: Final ranking score
        source_type:
          type: string
          enum: [web, academic, news]
          description: Source category

    SubQueryResponse:
      type: object
      properties:
        query:
          type: string
          description: Sub-query text
        intent:
          type: string
          enum: [definition, factual, opinion]
          description: Query intent
        priority:
          type: integer
          minimum: 1
          maximum: 10
          description: Execution priority

    ResearchRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          minLength: 1
          maxLength: 1000
          description: Research question
          example: What are AI agents and how do they work?
        mode:
          type: string
          enum: [speed, balanced, deep]
          default: balanced
          description: Search mode
        max_iterations:
          type: integer
          minimum: 1
          maximum: 10
          default: 5
          description: Maximum research iterations
        timeout:
          type: integer
          minimum: 60
          maximum: 600
          description: Timeout in seconds
        model:
          type: string
          nullable: true
          description: LLM model to use
        prompt_strategy:
          type: string
          enum: [static, dynamic, auto]
          default: auto
          description: System prompt strategy

    ResearchResponse:
      type: object
      properties:
        session_id:
          type: string
          format: uuid
        query:
          type: string
        plan:
          $ref: '#/components/schemas/ResearchPlanResponse'
        findings:
          type: string
          description: Synthesized research findings
        citations:
          type: array
          items:
            $ref: '#/components/schemas/CitationResponse'
        confidence:
          type: number
          minimum: 0.0
          maximum: 1.0
        execution_time:
          type: number
        execution_steps:
          type: array
          items:
            type: object
        model_used:
          type: string
        trace_url:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time

    ResearchPlanResponse:
      type: object
      properties:
        original_query:
          type: string
        steps:
          type: array
          items:
            $ref: '#/components/schemas/ResearchStepResponse'
        estimated_time:
          type: number
        complexity:
          type: string
          enum: [simple, moderate, complex]

    ResearchStepResponse:
      type: object
      properties:
        step_number:
          type: integer
          minimum: 1
        description:
          type: string
        search_query:
          type: string
        expected_outcome:
          type: string
        depends_on:
          type: array
          items:
            type: integer

    CitationResponse:
      type: object
      properties:
        source_id:
          type: string
        title:
          type: string
        url:
          type: string
          format: uri
        excerpt:
          type: string
        relevance:
          type: number
          minimum: 0.0
          maximum: 1.0

    DocumentUploadResponse:
      type: object
      properties:
        document_id:
          type: string
          format: uuid
        filename:
          type: string
        source_type:
          type: string
          enum: [pdf, word, excel, text]
        collection:
          type: string
        chunks_created:
          type: integer
        embedding_dimension:
          type: integer
        status:
          type: string
          enum: [success, partial, failed]
        message:
          type: string

    DocumentQueryRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          minLength: 1
          maxLength: 1000
          description: Question about documents
        collection:
          type: string
          default: default
          description: Collection to search
        top_k:
          type: integer
          minimum: 5
          maximum: 50
          default: 10
          description: Number of chunks to retrieve
        similarity_threshold:
          type: number
          minimum: 0.0
          maximum: 1.0
          default: 0.3
          description: Minimum similarity score
        model:
          type: string
          nullable: true
          description: LLM model for answer generation

    DocumentQueryResponse:
      type: object
      properties:
        query:
          type: string
        answer:
          type: string
        sources:
          type: array
          items:
            type: object
        total_chunks_found:
          type: integer
        chunks_used:
          type: integer
        execution_time:
          type: number
        trace_url:
          type: string
          nullable: true

    DocumentListItem:
      type: object
      properties:
        document_id:
          type: string
          format: uuid
        filename:
          type: string
        source_type:
          type: string
        collection:
          type: string
        chunks_count:
          type: integer
        created_at:
          type: string
          format: date-time
        last_accessed:
          type: string
          format: date-time
          nullable: true
        access_count:
          type: integer

    SessionResponse:
      type: object
      properties:
        session_id:
          type: string
          format: uuid
        query:
          type: string
        mode:
          type: string
          enum: [search, research]
        result:
          oneOf:
            - $ref: '#/components/schemas/SearchResponse'
            - $ref: '#/components/schemas/ResearchResponse'
          nullable: true
        created_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error type/code
        message:
          type: string
          description: Human-readable error message
        details:
          type: array
          nullable: true
          items:
            type: object
            properties:
              field:
                type: string
              message:
                type: string
              type:
                type: string
        trace_id:
          type: string
          nullable: true
          description: Request trace ID

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

tags:
  - name: Health
    description: Health check endpoints
  - name: Search
    description: Fast search with answer synthesis
  - name: Research
    description: Deep iterative research
  - name: Documents
    description: Document upload and RAG-based querying
  - name: Sessions
    description: Session tracking and retrieval
