services:
  # PostgreSQL with pgvector extension
  postgres:
    image: pgvector/pgvector:pg16
    container_name: privachat_postgres
    environment:
      POSTGRES_DB: research_db
      POSTGRES_USER: research_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "5433:5432"  # Use 5433 externally to avoid conflicts
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./src/database/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U research_user -d research_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - privachat-network

  # Redis for caching
  redis:
    image: redis:7-alpine
    container_name: privachat_redis
    ports:
      - "6380:6379"  # Use 6380 externally to avoid conflict with main Redis
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - privachat-network

  # PrivaChat Agents API
  privachat-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: privachat_api
    ports:
      - "8001:8000"  # Use 8001 externally to avoid conflict with other services
    environment:
      # Database
      DATABASE_URL: postgresql+asyncpg://research_user:${POSTGRES_PASSWORD}@postgres:5432/research_db
      
      # Redis
      REDIS_URL: redis://redis:6379/0
      
      # LLM & Monitoring
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}
      LANGFUSE_PUBLIC_KEY: ${LANGFUSE_PUBLIC_KEY}
      LANGFUSE_SECRET_KEY: ${LANGFUSE_SECRET_KEY}
      LANGFUSE_BASE_URL: ${LANGFUSE_BASE_URL}
      
      # Search (reuse from main app if available)
      # Connect to SearXNG container via Docker network
      SEARXNG_BASE_URL: ${SEARXNG_BASE_URL}
      SERPER_API_KEY: ${SERPER_API_KEY}
      
      # Perplexity AI (Fallback Search)
      PERPLEXITY_API_KEY: ${PERPLEXITY_API_KEY}
      PERPLEXITY_MODEL: ${PERPLEXITY_MODEL}
      PERPLEXITY_TIMEOUT: ${PERPLEXITY_TIMEOUT}
      PERPLEXITY_CIRCUIT_BREAKER_THRESHOLD: ${PERPLEXITY_CIRCUIT_BREAKER_THRESHOLD}
      PERPLEXITY_CIRCUIT_BREAKER_TIMEOUT: ${PERPLEXITY_CIRCUIT_BREAKER_TIMEOUT}
      ENABLE_SEARCH_FALLBACK: ${ENABLE_SEARCH_FALLBACK}
      
      # LLM Model Configuration
      LLM_MODEL: ${LLM_MODEL}
      RESEARCH_LLM_MODEL: ${RESEARCH_LLM_MODEL}
      RESEARCH_LLM_TEMPERATURE: ${RESEARCH_LLM_TEMPERATURE}
      RESEARCH_LLM_MAX_TOKENS: ${RESEARCH_LLM_MAX_TOKENS}
      RESEARCH_LLM_TIMEOUT: ${RESEARCH_LLM_TIMEOUT}
      FALLBACK_LLM_MODEL: ${FALLBACK_LLM_MODEL}
      SYNTHESIS_LLM_MODEL: ${SYNTHESIS_LLM_MODEL}
      
      # Prompt Strategy (Phase 4 - Configurable Prompts)
      ENABLE_DYNAMIC_PROMPTS: ${ENABLE_DYNAMIC_PROMPTS}
      
      # PyTorch/HuggingFace Settings (fix Dockling issues)
      TOKENIZERS_PARALLELISM: "false"
      OMP_NUM_THREADS: "1"
      MKL_NUM_THREADS: "1"
      
      # App settings
      LOG_LEVEL: ${LOG_LEVEL}
      API_RATE_LIMIT: ${API_RATE_LIMIT}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./src:/app/src
      - ./tests:/app/tests
    command: uvicorn src.main:app --host 0.0.0.0 --port 8000
    networks:
      - privachat-network
      - simple_perplexica_default  # Connect to main app's network for SearXNG access

  # Streamlit testing UI
  streamlit:
    build:
      context: .
      dockerfile: Dockerfile.streamlit
    container_name: privachat_streamlit
    profiles: ["ui"]
    ports:
      - "8503:8501"
    environment:
      API_BASE_URL: http://privachat-api:8000/api
    depends_on:
      - privachat-api
    volumes:
      - ./streamlit_ui.py:/app/streamlit_ui.py
    command: streamlit run streamlit_ui.py --server.address=0.0.0.0
    networks:
      - privachat-network
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:

networks:
  privachat-network:
    driver: bridge
  # Connect to main app's network to access SearXNG directly
  simple_perplexica_default:
    external: true
    name: simple_perplexica_default
